# 角色名片功能使用指南

## 功能概述
角色名片功能允许用户获取和查看游戏内角色的名片图片，支持本地缓存和历史记录查看。

## 主要特性

### 1. 智能缓存机制
- **本地图片缓存**: 名片图片会被下载并保存到本地，减少网络请求
- **基于Hash的更新**: 只有当名片内容发生变化时才会重新下载
- **历史版本保留**: 保留角色的历史名片，允许用户查看不同时期的名片

### 2. 使用方法

#### 查看角色名片
1. 进入"角色管理"页面
2. 在角色列表中找到目标角色
3. 向右滑动角色行，点击绿色的"名片"按钮
4. 系统会自动加载并显示角色名片

#### 手动刷新名片
- 在名片页面点击右上角的"刷新"按钮
- 系统会重新请求API并更新名片（如果有变化）

#### 查看历史名片
- 在名片页面点击"查看历史名片"按钮
- 可以浏览该角色的所有历史名片版本
- 支持删除不需要的历史版本

### 3. 技术实现

#### API调用
- **接口**: `https://www.jx3api.com/data/show/card`
- **参数**: 
  - `server`: 服务器名称
  - `name`: 角色名称
  - `token`: Token V2（付费API）

#### 缓存策略
- **图片存储**: 使用PNG格式保存到`Documents/CharacterCards/`目录
- **元数据存储**: 使用JSON格式保存缓存信息
- **文件命名**: `{服务器}_{角色名}_{Hash}_{时间戳}.png`

#### 更新逻辑
1. 首次访问: 直接从API获取并缓存
2. 后续访问: 优先使用缓存，除非手动刷新
3. 刷新时: 比较新旧Hash，只有变化时才更新

### 4. 配置要求

#### 必要配置
- **Token V2**: 在设置页面配置JX3API的Token V2
- **网络连接**: 首次获取名片需要网络连接

#### 存储管理
- **自动清理**: 系统会自动清理过期的缓存文件
- **手动管理**: 用户可以手动删除不需要的历史名片

### 5. 注意事项

#### API限制
- Token V2为付费API，请合理使用
- 系统会尽量减少API调用次数
- 缓存策略有效降低了重复请求

#### 存储空间
- 名片图片会占用本地存储空间
- 建议定期清理不需要的历史版本
- 系统会自动清理30天以上的旧缓存

#### 网络要求
- 首次获取名片需要稳定的网络连接
- 图片下载失败时会显示错误提示
- 支持重试机制

## 使用流程图

```
1. 用户选择角色 → 2. 检查本地缓存 → 3. 显示缓存名片
                     ↓ (无缓存)
                  4. 调用API → 5. 下载图片 → 6. 保存到本地 → 7. 显示名片
                     ↓
                  8. 用户点击刷新 → 9. 重新调用API → 10. 比较Hash
                     ↓
                  11. Hash不同 → 12. 更新缓存 → 13. 显示新名片
                     ↓
                  14. Hash相同 → 15. 不更新，显示现有名片
```

## 故障排除

### 常见问题
1. **名片加载失败**: 检查Token V2配置和网络连接
2. **图片显示异常**: 尝试手动刷新或清理缓存
3. **存储空间不足**: 清理历史名片或旧缓存

### 错误信息
- `"获取角色名片需要配置Token V2"`: 需要在设置中配置Token V2
- `"网络连接错误"`: 检查网络连接状态
- `"无法解析图片数据"`: 可能是API返回数据异常，稍后重试